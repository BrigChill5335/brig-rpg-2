name: Build Project and Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Project
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find CMakeLists.txt
      run: |
        echo "Поиск CMakeLists.txt файлов в репозитории:"
        dir CMakeLists.txt /s 2>nul || echo "CMakeLists.txt не найден в корне"
        echo "Содержимое папки projects:"
        dir projects
        echo "Содержимое папки dlls:"
        dir dlls

    - name: Try building from projects directory
      run: |
        cd projects
        cmake -A Win32 -B build
        cmake --build build --config Release
      
    - name: Check build results
      run: |
        echo "Поиск собранных DLL файлов:"
        dir projects\build /s 2>nul || echo "Папка build не найдена в projects"
        dir dlls /s 2>nul || echo "Папка dlls не содержит собранных файлов"

    - name: Create release archive
      run: |
        # Создаем временную папку для релиза
        mkdir release_files
        # Копируем возможные DLL файлы
        copy projects\build\dlls\Release\*.dll release_files\ 2>nul || echo "DLL не найдены в projects"
        copy projects\build\cl_dll\Release\*.dll release_files\ 2>nul || echo "Client DLL не найдены"
        
        # Создаем архив
        7z a -r brig-rpg-2-${{ github.ref_name }}.zip .\release_files\*
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          brig-rpg-2-${{ github.ref_name }}.zip
          projects/build/
        retention-days: 5

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref_name }}
        body: |
          Автоматически собранный релиз для версии ${{ github.ref_name }}
          
          ### Примечания
          - Сборка выполнена через GitHub Actions
          - Включает скомпилированные DLL файлы
        files: |
          brig-rpg-2-${{ github.ref_name }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
